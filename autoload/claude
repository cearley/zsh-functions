#!/usr/bin/env zsh

# Claude command proxy function.
# Checks for @anthropic-ai/claude-code package and installs if needed.
# Acts as transparent proxy to the actual claude command.

# Load zsh/parameter module for functions_source array
zmodload zsh/parameter 2>/dev/null

# shellcheck source=../lib/_common_proxy_lib
{
    # Primary: Use functions_source to get the actual file path (works with autoload)
    if [[ -v functions_source[$0] ]]; then
        source "${functions_source[$0]:h}/../lib/_common_proxy_lib" 2>/dev/null && sourced=1
    fi

    # Fallback: try the original relative path (direct execution, symlinks)
    if [[ ! -v sourced ]]; then
        source "${0:A:h}/../lib/_common_proxy_lib" 2>/dev/null && sourced=1
    fi
}

if [[ ! -v sourced ]]; then
    echo "Error: Could not load common proxy library." >&2
    return 1
fi

# Main claude function - this gets redefined to be the actual function.
claude() {
    local claude_pkg="@anthropic-ai/claude-code"
    
    if ! _common_check_nodejs_version 18 "claude"; then
        return 1
    fi
    
    if ! _common_is_installed "$claude_pkg"; then
        if _common_prompt_install "$claude_pkg"; then
            if ! _common_install_package "$claude_pkg"; then
                echo "Installation failed. Exiting." >&2
                return 1
            fi
        else
            echo "Installation declined. Exiting."
            return 0
        fi
    fi

    # Run the actual claude command with all passed arguments and handle errors
    _common_run_command "claude" "$@"
}

# Run the function with the current arguments.
claude "$@"
