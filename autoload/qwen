#!/usr/bin/env zsh

# Qwen command proxy function.
# Checks for @qwen-code/qwen-code package and installs if needed.
# Acts as transparent proxy to the actual qwen command.

_qwen_check_nodejs_version() {
    if ! command -v node >/dev/null 2>&1; then
        echo "Error: Node.js is not installed. Please install Node.js version 20 or higher." >&2
        return 1
    fi

    if ! command -v npm >/dev/null 2>&1; then
        echo "Error: npm is not available. Please ensure npm is installed and in your PATH." >&2
        return 1
    fi

    local node_version
    node_version=$(node --version 2>/dev/null | sed 's/^v//')

    if [[ -z "$node_version" ]]; then
        echo "Error: Could not determine Node.js version." >&2
        return 1
    fi

    local major_version
    major_version=$(echo "$node_version" | cut -d. -f1)

    if [[ "$major_version" -lt 20 ]]; then
        echo "Error: Node.js version $node_version is too old. Please install Node.js version 20 or higher." >&2
        return 1
    fi

    return 0
}

_qwen_is_installed() {
    local qwen_pkg="$1"
    npm list -g "$qwen_pkg" >/dev/null 2>&1
}

_qwen_prompt_install() {
    local qwen_pkg="$1"
    echo "The $qwen_pkg npm package is not installed."
    echo -n "Would you like to install it globally? (y/N): "
    read -r response
    case "$response" in
        [yY]|[yY][eE][sS])
            return 0
            ;;
        *)
            return 1
            ;;
    esac
}

_qwen_install_package() {
    local qwen_pkg="$1"
    echo "Installing $qwen_pkg globally..."
    if npm install -g "$qwen_pkg@latest"; then
        echo "Successfully installed $qwen_pkg"
        return 0
    else
        echo "Failed to install $qwen_pkg" >&2
        return 1
    fi
}

# Main qwen function - this gets redefined to be the actual function.
qwen() {
    local qwen_pkg="@qwen-code/qwen-code"

    if ! _qwen_check_nodejs_version; then
        return 1
    fi

    if ! _qwen_is_installed "$qwen_pkg"; then
        if _qwen_prompt_install "$qwen_pkg"; then
            if ! _qwen_install_package "$qwen_pkg"; then
                echo "Installation failed. Exiting." >&2
                return 1
            fi
        else
            echo "Installation declined. Exiting."
            return 0
        fi
    fi

    # Run the actual qwen command with all passed arguments and handle errors
    command qwen "$@"
    local exit_code=$?
    if [ $exit_code -ne 0 ]; then
        echo "Error: Qwen command failed with exit code $exit_code" >&2
        return $exit_code
    fi
}

# Run the function with the current arguments.
qwen "$@"